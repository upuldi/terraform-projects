# Terraform Modular AWS VPC, ASG, and ALB Setup

## Overview
This project provisions a modular AWS infrastructure using Terraform, including:
- **VPC** with public and private subnets across multiple AZs
- **Internet Gateway**, **NAT Gateway**, and route tables
- **Security groups** with least-privilege access
- **Launch templates** for EC2 configuration with enhanced options
- **Auto Scaling Groups (ASGs)** with automatic scaling policies
- **Application Load Balancer (ALB)** for high availability
- **IAM roles** and instance profiles for SSM Session Manager
- **Dynamic scaling policies** based on CPU utilization
- **CloudWatch alarms** for monitoring and alerting

## Architecture
```
Internet Gateway
       |
   Public Subnets (Multi-AZ)
       |
Application Load Balancer
       |
Auto Scaling Group
       |
EC2 Instances (Launch Template)
       |
   Private Subnets (Multi-AZ)
       |
   NAT Gateway
```

## Features
- ✅ **Modular Design**: All components are reusable modules
- ✅ **Multi-AZ Deployment**: High availability across availability zones
- ✅ **Auto Scaling**: CPU-based scaling with configurable thresholds
- ✅ **Security**: Least-privilege security groups and encrypted EBS volumes
- ✅ **Monitoring**: CloudWatch alarms and detailed monitoring
- ✅ **SSM Access**: Secure instance access without SSH keys
- ✅ **Environment Support**: Dev/staging/prod environments
- ✅ **Cost Optimization**: Configurable NAT gateway options
- ✅ **Validation**: Input validation for all variables

## Quick Start

### 1. Prerequisites
- AWS CLI configured with appropriate permissions
- Terraform >= 0.14
- An existing AWS account

### 2. Clone and Initialize
```bash
git clone <repository-url>
cd vpc-asg-ec2
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your values
terraform init
```

### 3. Plan and Deploy
```bash
terraform plan
terraform apply
```

### 4. Access Your Application
```bash
# Get the ALB DNS name
terraform output public_alb_dns_name
# Access via browser: http://<alb-dns-name>
```

## Configuration

### Environment Variables
Set your environment in `terraform.tfvars`:
```hcl
environment = "dev"    # dev, staging, or prod
name        = "myapp"
region      = "us-west-2"
```

### Scaling Configuration
```hcl
# Auto Scaling Group
asg_desired_capacity = 2
asg_max_size        = 5
asg_min_size        = 1

# Scaling Policies
scale_up_threshold   = 70  # CPU % to scale up
scale_down_threshold = 20  # CPU % to scale down
scaling_adjustment   = 1   # Instances to add/remove
```

### Security Configuration
```hcl
# EC2 Configuration
instance_type     = "t3.micro"
key_pair_name     = "my-key"      # Optional for SSH
enable_monitoring = true
ebs_optimized    = true
```

## Module Structure
```
modules/
├── vpc/              # VPC, subnets, gateways, routing
├── sec_group/        # Security groups with flexible rules
├── iam/             # IAM roles and instance profiles
├── launch_template/ # EC2 launch templates with options
├── asg/             # Auto Scaling Groups with policies
└── alb/             # Application Load Balancer
```

## Outputs
After deployment, you'll get:
- `public_alb_dns_name` - Access URL for your application
- `vpc_id` - VPC identifier
- `subnet_ids` - Public and private subnet identifiers
- `security_group_ids` - Security group identifiers
- `iam_instance_profile_name` - Instance profile for SSM

## Advanced Usage

### Multi-Environment Deployment
```bash
# Development
terraform workspace new dev
terraform apply -var="environment=dev"

# Production
terraform workspace new prod
terraform apply -var="environment=prod"
```

### Cost Optimization
```hcl
# Use single NAT gateway (reduces cost)
single_nat_gateway = true

# Disable NAT gateway entirely
enable_nat_gateway = false

# Use smaller instances
instance_type = "t2.nano"
```

### Monitoring and Alerting
The infrastructure includes:
- CPU utilization alarms
- Auto scaling notifications
- ELB health checks
- CloudWatch detailed monitoring

## Security Best Practices
- ✅ All EBS volumes are encrypted
- ✅ Security groups follow least-privilege principle
- ✅ Instance profiles instead of access keys
- ✅ SSM Session Manager for secure access
- ✅ ALB terminates SSL (configure certificate_arn)
- ✅ Private subnets for application tiers

## Troubleshooting

### Common Issues
1. **Permission Denied**: Ensure AWS credentials have sufficient permissions
2. **Resource Limits**: Check AWS service limits for your region
3. **Subnet Conflicts**: Ensure CIDR blocks don't overlap
4. **Key Pair**: Create EC2 key pair if using SSH access

### Validation
```bash
# Check configuration
terraform validate

# Format code
terraform fmt -recursive

# Plan without applying
terraform plan
```

## Contributing
1. Follow Terraform best practices
2. Add validation to new variables
3. Update documentation for new features
4. Test in dev environment first

## License
[Your License Here]

---

**Generated by**: Terraform refactoring process
**Last Updated**: $(date)
**Terraform Version**: >= 0.14
